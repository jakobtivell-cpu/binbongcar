<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Egaux — Dynamic Comparison</title>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f7f7f8;
      --panel:#fff;
      --ink:#0b0c0f;
      --muted:#6f7685;
      --line:#e6e7ea;
      --shadow:0 10px 30px rgba(16,18,25,.08);
      --shadow-soft:0 6px 16px rgba(16,18,25,.06);
      --accent:#111;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background:var(--bg);
      color:var(--ink);
      height:100vh;
      overflow:hidden;
    }

    .wrap{
      display:grid;
      grid-template-rows:auto auto auto 1fr;
      gap:10px;
      padding:14px;
      height:100vh;
      min-height:0;
    }

    header{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:var(--shadow);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px;}
    .note{ font-size:12px; color:var(--muted); font-weight:650; }

    .btn{
      border:0; padding:9px 12px; border-radius:10px;
      background:var(--accent); color:#fff; font-weight:900; cursor:pointer;
      box-shadow:var(--shadow-soft); letter-spacing:.4px; font-size:12px;
    }
    .btn.secondary{ background:#fff; color:#111; border:1px solid var(--line); }

    .toolbar{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      box-shadow:var(--shadow);
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      min-height:0;
    }
    .toolbar input[type="text"]{
      padding:8px 10px; font-size:12px; width:280px;
      border:1px solid var(--line); border-radius:9px; background:#fff; font-weight:650;
    }
    details.columns-panel{
      border:1px dashed var(--line); padding:6px 8px; border-radius:10px; background:#fff; font-size:12px;
    }
    details.columns-panel summary{ cursor:pointer; font-weight:800; }
    .col-list{ margin-top:6px; display:flex; flex-wrap:wrap; gap:10px; }
    .col-item{ display:flex; align-items:center; gap:6px; }

    .summary{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:8px 10px;
      display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:8px;
      font-size:12px;
    }
    .summary .card{
      background:#fff; border:1px solid #f0f1f3; padding:8px; border-radius:10px;
      box-shadow:var(--shadow-soft);
    }
    .summary .label{ font-weight:900; margin-bottom:2px; }
    .summary .value{ font-variant-numeric: tabular-nums; font-size:14px; font-weight:950; }

    .table-wrap{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:0;
      overflow:auto;
      min-height:0;
    }

    table{ border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td{ border: 1px solid var(--line); padding: 6px 8px; font-size: 12px; vertical-align: middle; }
    th{
      background: #fafafa;
      position: sticky; top: 0; z-index: 2; user-select:none;
      font-weight:900;
    }
    td:first-child, th:first-child{ position: sticky; left: 0; background: #fff; z-index: 1;}
    th:first-child{ background:#fafafa; z-index:3;}

    input.mult{
      width: 86px; padding: 5px 6px; font-size: 12px;
      border:1px solid var(--line); border-radius:8px; font-weight:850;
      text-align:right;
    }
    .num{ text-align: right; font-variant-numeric: tabular-nums; }
    .center{ text-align: center; }
    .total-row td{ font-weight: 950; background: #fafafa; }
    .contrib{ color:#0a3; font-weight:900;}
    .neg{ color:#b00; font-weight:900;}

    th.model-col{ cursor: grab; }
    th.model-col.dragging{ opacity:0.5; }

    .headModel{
      display:flex; align-items:center; gap:8px;
      min-width:0;
    }
    .headModel img{
      width:44px; height:30px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f3f4f6;
      object-fit:contain;
      flex:0 0 auto;
    }
    .headModel .t{
      min-width:0;
    }
    .headModel .name{
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .headModel .sub{
      font-size:10px;
      color:var(--muted);
      font-weight:750;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div>
      <h1>Comparison — CSV Driven</h1>
      <div class="note" id="sourceNote">Source: Product_data_filled_updated.csv</div>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn secondary" onclick="window.location.href='index.html'">Back to selection</button>
      <button class="btn" id="exportBtn">Download Excel</button>
    </div>
  </header>

  <div class="toolbar">
    <button class="btn secondary" id="resetBtn">Reset multipliers</button>
    <button class="btn secondary" id="sampleBtn">Sample multipliers</button>
    <input id="filterInput" type="text" placeholder="Filter fields (type any column name)"/>
    <details class="columns-panel">
      <summary>Models (hide/show + drag headers to reorder)</summary>
      <div id="colList" class="col-list"></div>
    </details>
  </div>

  <div id="topSummary" class="summary"></div>

  <div class="table-wrap">
    <table id="specTable">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
      <tfoot id="tfoot"></tfoot>
    </table>
  </div>

</div>

<script>
/** ============================
 *  CONFIG
 *  ============================ */
const CSV_PATH = "Product_data_filled_updated.csv";
const SELECTION_KEY = "egaux_selected_ids_v1";
const MULT_KEY = "egaux_field_multipliers_v1";
const COL_KEY  = "egaux_compare_modelcols_v1";

// fallback icon (same for all missing images)
const FALLBACK_ICON = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAAA9CAYAAAAQyx+GAAAAAXNSR0IArs4c6QAAAKFJREFUeF7t2TEKwDAQRNH//1o9qQmQJYl0kM2o8q9bQm2wYkQAAAAAAAAAAAAAAADwq5pY0y0n2k6mG9b0o5w0o8G2o6a9y1y8Qz5l0wQw9c6wX7m4mXq0b6m8v2fY3n8m0o0d9c0p6o3o0o9o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0oAAAAAAAAAAAAAAADgF7wBv7v2a2o3qgAAAABJRU5ErkJggg==";

/** ============================
 *  STATE
 *  ============================ */
let headers = [];
let rows = [];           // all csv rows
let selectedIds = [];    // from localStorage (ordered)
let selectedRows = [];   // selected row objects in that order

let cols = {};           // detected columns for brand/model etc
let fields = [];         // table rows = CSV column names

let multMap = {};        // multipliers per field (column)
let colState = [];       // visible model columns + order
let lastTotals = {};     // totals per model key (for export)

/** ============================
 *  UTILS
 *  ============================ */
function normKey(s){
  return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"");
}
function resolveColumn(headerList, candidates){
  const map = new Map(headerList.map(h => [normKey(h), h]));
  for(const c of candidates){
    const k = normKey(c);
    if(map.has(k)) return map.get(k);
  }
  for(const c of candidates){
    const ck = normKey(c);
    for(const h of headerList){
      if(normKey(h).includes(ck)) return h;
    }
  }
  return null;
}
function detectColumns(headerList){
  return {
    brand: resolveColumn(headerList, ["brand","make","manufacturer","oem","marque","märke"]),
    model: resolveColumn(headerList, ["model","carline","vehicle","name","modelname"]),
    variant: resolveColumn(headerList, ["variant","trim","version","derivative","grade"]),
    year: resolveColumn(headerList, ["year","modelyear","my"]),
    segment: resolveColumn(headerList, ["segment","bodysegment","segmentgroup","bodystyle","body"]),
    vehicleClass: resolveColumn(headerList, ["vehicleclass","pcv_lcv","pcv/lcv","class","vehicletype"]),
    fuel: resolveColumn(headerList, ["fuel","fueltype","powertrain","energy","drivetrain"])
  };
}
function normBrand(s){
  return String(s||"")
    .trim().toUpperCase()
    .replace(/&/g,"AND")
    .replace(/\s+/g,"-")
    .replace(/[^A-Z0-9-]/g,"");
}
function normModel(s){
  return String(s||"")
    .trim().toUpperCase()
    .replace(/&/g,"AND")
    .replace(/[\/\\]+/g,"_")
    .replace(/\s+/g,"_")
    .replace(/[^A-Z0-9_-]/g,"");
}
function imageUrlForRow(r){
  const b = cols.brand ? r[cols.brand] : "";
  const m = cols.model ? r[cols.model] : "";
  const brand = normBrand(b);
  const model = normModel(m);
  if(!brand || !model) return FALLBACK_ICON;
  return `images/${brand}_${model}.png`;
}
function rowDisplayName(r){
  const b = cols.brand ? r[cols.brand] : "";
  const m = cols.model ? r[cols.model] : "";
  const v = cols.variant ? r[cols.variant] : "";
  const y = cols.year ? r[cols.year] : "";
  const base = [b,m].filter(Boolean).join(" ").trim();
  const extra = [y,v].filter(Boolean).join(" ").trim();
  return (base + (extra ? (" " + extra) : "")).trim() || r.__id || "Vehicle";
}
function rowSubline(r){
  const seg = cols.segment ? r[cols.segment] : "";
  const vc  = cols.vehicleClass ? r[cols.vehicleClass] : "";
  const fuel= cols.fuel ? r[cols.fuel] : "";
  return [seg,vc,fuel].filter(Boolean).join(" • ");
}

/** numeric parsing for contribution */
function parseNumeric(v){
  if(v == null) return null;
  if(typeof v === "number" && Number.isFinite(v)) return v;
  const s0 = String(v).trim();
  if(!s0 || s0 === "—") return null;

  // range like 536–641 or 536-641
  const rm = s0.match(/(-?\d+(?:[.,]\d+)?)\s*[–-]\s*(-?\d+(?:[.,]\d+)?)/);
  if(rm){
    const a = parseFloat(rm[1].replace(",", "."));
    const b = parseFloat(rm[2].replace(",", "."));
    if(Number.isFinite(a) && Number.isFinite(b)) return (a+b)/2;
  }

  // keep digits, commas, dots, minus
  let s = s0.replace(/[^\d.,\-]/g,"");
  if(!s) return null;

  // decide decimal separator if both present
  const lastDot = s.lastIndexOf(".");
  const lastComma = s.lastIndexOf(",");
  if(lastDot !== -1 && lastComma !== -1){
    if(lastDot > lastComma){
      // dot decimal, remove commas
      s = s.replace(/,/g,"");
    }else{
      // comma decimal, remove dots, replace comma with dot
      s = s.replace(/\./g,"").replace(/,/g,".");
    }
  }else if(lastComma !== -1 && lastDot === -1){
    // treat comma as decimal
    s = s.replace(/,/g,".");
  }else{
    // dot decimal or integer; leave as-is
  }

  const num = parseFloat(s);
  return Number.isFinite(num) ? num : null;
}

/** local storage helpers */
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

/** multipliers by field */
function getMultiplier(field){
  const m = multMap[field];
  return (m == null || m === "") ? 0 : Number(m);
}
function setMultiplier(field, val){
  multMap[field] = val;
  saveJSON(MULT_KEY, multMap);
}

/** model column state */
function saveColState(){ saveJSON(COL_KEY, colState); }
function visibleModels(){
  return colState.filter(c => c.visible).map(c => selectedRows.find(r => r.__id === c.key));
}

/** ============================
 *  LOAD + PREP
 *  ============================ */
async function loadCSV(){
  const res = await fetch(CSV_PATH, { cache:"no-store" });
  if(!res.ok) throw new Error(`Failed to load ${CSV_PATH} (${res.status})`);
  const text = await res.text();
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  headers = parsed.meta?.fields || Object.keys(parsed.data?.[0] || {});
  cols = detectColumns(headers);

  // enrich rows with stable __id
  const idCol = resolveColumn(headers, ["id","vehicle_id","product_id","uuid","key"]);
  rows = (parsed.data || []).map((r, idx) => {
    const b = cols.brand ? r[cols.brand] : "";
    const m = cols.model ? r[cols.model] : "";
    const stable = (idCol && r[idCol]) ? String(r[idCol]) : `${normBrand(b)}_${normModel(m)}_${idx}`;
    return { ...r, __id: stable, __idx: idx };
  });
}

function loadSelection(){
  const ids = loadJSON(SELECTION_KEY, []);
  selectedIds = Array.isArray(ids) ? ids : [];
  if(!selectedIds.length){
    // fallback: pick first 5 so page isn't empty
    selectedIds = rows.slice(0,5).map(r => r.__id);
  }

  // keep selection order
  const map = new Map(rows.map(r => [r.__id, r]));
  selectedRows = selectedIds.map(id => map.get(id)).filter(Boolean);

  // model columns (order + visibility)
  const defaultState = selectedRows.map(r => ({ key:r.__id, visible:true }));
  colState = loadJSON(COL_KEY, defaultState);

  // ensure any new ones appear
  for(const r of selectedRows){
    if(!colState.find(c => c.key === r.__id)) colState.push({ key:r.__id, visible:true });
  }

  // multipliers
  multMap = loadJSON(MULT_KEY, {});
}

function buildFields(){
  // Every CSV column becomes a "fact row"
  // We exclude internal columns.
  fields = headers.filter(h => h && !String(h).startsWith("__"));
}

/** ============================
 *  UI: column panel
 *  ============================ */
const colList = document.getElementById("colList");
function renderColumnPanel(){
  colList.innerHTML = "";
  for(const c of colState){
    const r = selectedRows.find(x => x.__id === c.key);
    if(!r) continue;
    const label = rowDisplayName(r);

    const wrap = document.createElement("label");
    wrap.className = "col-item";
    wrap.innerHTML = `
      <input type="checkbox" data-key="${c.key}" ${c.visible ? "checked":""}/>
      <span>${label}</span>
    `;
    wrap.querySelector("input").addEventListener("change", e => {
      const key = e.target.dataset.key;
      const item = colState.find(x => x.key === key);
      item.visible = e.target.checked;
      saveColState();
      render();
    });
    colList.appendChild(wrap);
  }
}

/** ============================
 *  RENDER TABLE
 *  ============================ */
const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");
const tfoot = document.getElementById("tfoot");
const topSummary = document.getElementById("topSummary");
const filterInput = document.getElementById("filterInput");

function render(){
  renderColumnPanel();

  const filter = filterInput.value.trim().toLowerCase();
  const vis = visibleModels().filter(Boolean);

  // header
  thead.innerHTML = `
    <tr>
      <th style="width:360px;">Field (CSV column)</th>
      <th style="width:120px;" class="center">Multiplier</th>
      ${vis.map(r => {
        const img = imageUrlForRow(r);
        const name = rowDisplayName(r);
        const sub = rowSubline(r);
        return `
          <th class="model-col" draggable="true" data-key="${r.__id}" style="min-width:220px;">
            <div class="headModel">
              <img src="${img}" onerror="this.src='${FALLBACK_ICON}'" alt="${name}"/>
              <div class="t">
                <div class="name">${escapeHtml(name)}</div>
                <div class="sub">${escapeHtml(sub || "")}</div>
              </div>
            </div>
          </th>
        `;
      }).join("")}
    </tr>
  `;
  attachHeaderDnD();

  // body
  tbody.innerHTML = "";
  const totals = Object.fromEntries(vis.map(r => [r.__id, 0]));

  for(const field of fields){
    if(filter && !String(field).toLowerCase().includes(filter)) continue;

    const mult = getMultiplier(field);
    const cells = vis.map(r => {
      const raw = r[field];
      const num = parseNumeric(raw);
      const contrib = (num != null) ? num * mult : null;
      if(contrib != null) totals[r.__id] += contrib;

      const displayVal = (raw == null || String(raw).trim()==="") ? "—" : String(raw);
      const displayContrib = (contrib == null) ? "—" : contrib.toFixed(3);
      const cls = (contrib == null) ? "" : (contrib < 0 ? "neg" : "contrib");

      return `
        <td class="num">
          <div>${escapeHtml(displayVal)}</div>
          <div class="${cls}" style="font-size:11px;">${escapeHtml(displayContrib)}</div>
        </td>
      `;
    }).join("");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(field)}</strong></td>
      <td class="center">
        <input class="mult" type="number" step="0.001" min="-1000" max="1000"
               data-field="${escapeAttr(field)}" value="${mult}">
      </td>
      ${cells}
    `;
    tbody.appendChild(tr);
  }

  // footer totals
  tfoot.innerHTML = `
    <tr class="total-row">
      <td colspan="2">Total weighted value</td>
      ${vis.map(r => `<td class="num">${totals[r.__id].toFixed(3)}</td>`).join("")}
    </tr>
  `;

  // summary
  topSummary.innerHTML = vis.map(r => `
    <div class="card">
      <div class="label">${escapeHtml(rowDisplayName(r))}</div>
      <div class="value">${totals[r.__id].toFixed(3)}</div>
      <div class="note">${escapeHtml(rowSubline(r) || r.__id)}</div>
    </div>
  `).join("");

  lastTotals = totals;

  // multiplier input handlers
  document.querySelectorAll("input.mult").forEach(inp => {
    inp.addEventListener("input", e => {
      const field = e.target.dataset.field;
      let v = Number(e.target.value);
      if(!Number.isFinite(v)) v = 0;
      if(v > 1000) v = 1000;
      if(v < -1000) v = -1000;
      e.target.value = v;
      setMultiplier(field, v);
      render();
    });
  });
}

/** drag reorder model columns */
function attachHeaderDnD(){
  const headers = [...thead.querySelectorAll("th.model-col")];
  let dragKey = null;

  headers.forEach(h => {
    h.addEventListener("dragstart", e => {
      dragKey = h.dataset.key;
      h.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    h.addEventListener("dragend", () => {
      h.classList.remove("dragging");
      dragKey = null;
    });
    h.addEventListener("dragover", e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    });
    h.addEventListener("drop", e => {
      e.preventDefault();
      const targetKey = h.dataset.key;
      if(!dragKey || dragKey === targetKey) return;

      const fromIdx = colState.findIndex(c => c.key === dragKey);
      const toIdx   = colState.findIndex(c => c.key === targetKey);
      const [moved] = colState.splice(fromIdx, 1);
      colState.splice(toIdx, 0, moved);
      saveColState();
      render();
    });
  });
}

/** ============================
 *  EXCEL EXPORT (AS DISPLAYED)
 *  - One model column per selected model (in current visible order)
 *  - Each cell: raw + newline + contrib
 *  - Respects field filter
 *  ============================ */
document.getElementById("exportBtn").onclick = () => {
  const vis = visibleModels().filter(Boolean);
  const filter = filterInput.value.trim().toLowerCase();

  const headerRow = ["Field", "Multiplier", ...vis.map(r => rowDisplayName(r))];
  const aoa = [headerRow];

  for(const field of fields){
    if(filter && !String(field).toLowerCase().includes(filter)) continue;

    const mult = getMultiplier(field);
    const row = [field, mult];

    for(const r of vis){
      const raw = r[field];
      const num = parseNumeric(raw);
      const contrib = (num != null) ? num * mult : null;

      const displayVal = (raw == null || String(raw).trim()==="") ? "—" : String(raw);
      const displayContrib = (contrib == null) ? "—" : contrib.toFixed(3);

      row.push(`${displayVal}\n${displayContrib}`);
    }
    aoa.push(row);
  }

  // totals row
  const totalsRow = ["Total weighted value", "", ...vis.map(r => (lastTotals[r.__id] ?? 0).toFixed(3))];
  aoa.push(totalsRow);

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);

  // widths
  ws["!cols"] = [
    { wch: 34 }, // Field
    { wch: 12 }, // Multiplier
    ...vis.map(() => ({ wch: 26 }))
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Comparison");
  const filename = `egaux_compare_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, filename);
};

/** ============================
 *  TOOLBAR BUTTONS
 *  ============================ */
document.getElementById("resetBtn").onclick = () => {
  multMap = {};
  saveJSON(MULT_KEY, multMap);
  render();
};

document.getElementById("sampleBtn").onclick = () => {
  // sample multipliers on a few likely columns (if present)
  const sample = {};
  for(const h of headers){
    const k = normKey(h);
    if(k.includes("price") || k.includes("msrp")) sample[h] = -0.0001;
    if(k.includes("range")) sample[h] = +1;
    if(k.includes("power") || k.includes("kw") || k.includes("hp")) sample[h] = +0.1;
    if(k.includes("weight")) sample[h] = -0.01;
    if(k.includes("co2")) sample[h] = -1;
  }
  multMap = { ...multMap, ...sample };
  saveJSON(MULT_KEY, multMap);
  render();
};

filterInput.addEventListener("input", render);

/** ============================
 *  SAFETY: escape helpers
 *  ============================ */
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function escapeAttr(s){
  return String(s ?? "").replace(/"/g,"&quot;");
}

/** ============================
 *  INIT
 *  ============================ */
(async function init(){
  try{
    await loadCSV();
    loadSelection();
    buildFields();
    render();
  }catch(err){
    console.error(err);
    alert(
      "Could not load Product_data_filled_updated.csv.\n" +
      "Make sure it is deployed next to compare.html."
    );
  }
})();
</script>
</body>
</html>
