<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Egaux — Vehicle Selection</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --ink:#0b0c0f;
      --muted:#6f7685;
      --line:#e6e7ea;
      --shadow:0 18px 50px rgba(0,0,0,.06);
      --shadow-soft:0 10px 24px rgba(0,0,0,.06);
      --accent:#111;
      --pill:#0b0c0f;
      --pill-ink:#fff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg);
      color:var(--ink);
      height:100vh;
      overflow:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: 280px 1fr 520px;
      gap:14px;
      padding:14px;
      height:100vh;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }
    .panel header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .panel header .title{
      font-weight:900;
      letter-spacing:.2px;
    }
    .panel header .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:650;
      margin-top:4px;
    }
    .content{
      padding:14px;
      height:calc(100% - 58px);
      overflow:auto;
    }

    .badge{
      background:#f2f3f5;
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 10px;
      font-weight:800;
      color:#111;
      font-size:12px;
      white-space:nowrap;
    }

    /* Filters */
    .group{ margin:12px 0 18px; }
    .label{
      font-weight:900;
      font-size:12px;
      letter-spacing:.12em;
      color:#111;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .seglist{ display:flex; flex-direction:column; gap:8px; }
    .segitem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      background:#fff;
      box-shadow:var(--shadow-soft);
      font-weight:850;
    }
    .segitem small{
      font-weight:800;
      color:var(--muted);
    }
    .segitem.active{
      border-color:#111;
      box-shadow: inset 0 0 0 1px #111;
    }
    select, input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-weight:750;
      background:#fff;
      box-shadow:var(--shadow-soft);
      outline:none;
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:0;
      background:#111;
      color:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow:var(--shadow-soft);
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--line);
      font-weight:900;
    }

    /* Center ring (NO start button) */
    .ringWrap{
      height:100%;
      display:grid;
      place-items:center;
      padding:14px;
    }
    .ringCard{
      width:min(520px, 100%);
      height:min(520px, 100%);
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      background:#fff;
      position:relative;
      overflow:hidden;
    }
    .ringHeader{
      position:absolute;
      left:14px;
      top:14px;
      right:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      z-index:5;
    }
    .ringHeader .h{
      font-weight:950;
    }
    .ringHeader .s{
      font-size:12px;
      color:var(--muted);
      font-weight:650;
      margin-top:4px;
    }

    .ringStage{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding-top:10px;
    }
    .ring{
      width:78%;
      height:78%;
      border-radius:999px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at center, rgba(0,0,0,0.02), rgba(0,0,0,0) 60%),
        radial-gradient(circle at center, #fff, #fbfbfc);
      box-shadow: inset 0 0 0 12px rgba(0,0,0,0.015);
      position:relative;
    }
    .slot{
      position:absolute;
      width:170px;
      height:56px;
      border-radius:14px;
      border:1px dashed #d7d9de;
      background:#fff;
      box-shadow:var(--shadow-soft);
      transform:translate(-50%,-50%);
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      overflow:hidden;
    }
    .slot.empty{
      background: #fcfcfd;
      color:#a0a6b3;
      font-weight:800;
      justify-content:center;
    }
    .slot .thumb{
      width:44px;height:32px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f3f4f6;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .slot img{ max-width:100%; max-height:100%; }
    .slot .name{
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .slot .x{
      width:22px;height:22px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      display:grid;
      place-items:center;
      font-weight:950;
      cursor:pointer;
      flex:0 0 auto;
    }
    .slot.over{
      border-color:#111;
      box-shadow: inset 0 0 0 1px #111, var(--shadow-soft);
    }

    /* Models grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
      gap:12px;
      padding-bottom:10px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow-soft);
      padding:10px;
      display:flex;
      gap:10px;
      cursor:pointer;
      transition:.15s ease;
    }
    .card:hover{ transform:translateY(-2px); }
    .card.selected{
      border-color:#111;
      box-shadow: inset 0 0 0 1px #111, var(--shadow-soft);
    }
    .card .thumb{
      width:66px;height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f3f4f6;
      display:grid;
      place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .card .thumb img{ max-width:100%; max-height:100%; }
    .meta{ min-width:0; flex:1; }
    .meta .name{
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:650;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .tag{
      background:var(--pill);
      color:var(--pill-ink);
      font-size:10px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      letter-spacing:.02em;
    }

    .footerBar{
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:#fff;
      display:grid;
      gap:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      margin:0 0 6px;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Filters -->
  <aside class="panel">
    <header>
      <div>
        <div class="title">Filters</div>
        <div class="sub">Brand/model shown once</div>
      </div>
      <div class="badge" id="shownBadge">0 shown</div>
    </header>
    <div class="content">
      <div class="group">
        <div class="label">Segment</div>
        <div class="seglist" id="segmentList"></div>
      </div>

      <div class="group">
        <div class="label">Vehicle class</div>
        <select id="vehicleClassSelect">
          <option value="">All (PCV + LCV)</option>
          <option value="PCV">PCV</option>
          <option value="LCV">LCV</option>
        </select>
      </div>

      <div class="group">
        <div class="label">Fuel type</div>
        <select id="fuelSelect">
          <option value="">All fuels</option>
        </select>
      </div>

      <button class="btn secondary" id="clearFiltersBtn">Clear filters</button>
    </div>
  </aside>

  <!-- Ring -->
  <section class="panel ringWrap">
    <div class="ringCard">
      <div class="ringHeader">
        <div>
          <div class="h">Comparison Ring</div>
          <div class="s">Click or drag models to add</div>
        </div>
        <div class="badge" id="pickedBadge">0/10 picked</div>
      </div>

      <div class="ringStage">
        <div class="ring" id="ring"></div>
      </div>
    </div>
  </section>

  <!-- Models -->
  <main class="panel">
    <header>
      <div>
        <div class="title">Models</div>
        <div class="sub">Unique by Brand/Model</div>
      </div>
      <div class="badge" id="dataBadge">CSV</div>
    </header>

    <div class="content">
      <div class="grid" id="grid"></div>
    </div>

    <div class="footerBar">
      <div class="field">
        <label>Report style</label>
        <select id="reportStyle">
          <option>Strategic overview</option>
          <option>Tactical pricing</option>
          <option>Spec deep dive</option>
        </select>
      </div>

      <div class="field">
        <label>Notes / selection name</label>
        <input id="notes" placeholder="e.g., Nordic EV comp set Q1"/>
      </div>

      <button class="btn" id="openCompareBtn">Open comparison</button>
    </div>
  </main>

</div>

<script>
/** ============================
 *  CONFIG
 *  ============================ */
const CSV_PATH = "Product_data_filled_updated.csv";
const COMPARE_PAGE = "compare.html";
const SLOT_COUNT = 10;

// fallback icon (one icon for all missing)
const FALLBACK_ICON = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAAA9CAYAAAAQyx+GAAAAAXNSR0IArs4c6QAAAKFJREFUeF7t2TEKwDAQRNH//1o9qQmQJYl0kM2o8q9bQm2wYkQAAAAAAAAAAAAAAADwq5pY0y0n2k6mG9b0o5w0o8G2o6a9y1y8Qz5l0wQw9c6wX7m4mXq0b6m8v2fY3n8m0o0d9c0p6o3o0o9o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0o0oAAAAAAAAAAAAAAADgF7wBv7v2a2o3qgAAAABJRU5ErkJggg==";

/** ============================
 *  STATE
 *  ============================ */
let headers = [];
let rawRows = [];
let rows = [];               // enriched raw rows with __id
let groups = [];             // unique brand/model groups
let groupMap = new Map();    // key -> group
const missingImage = new Set();

let cols = {};
let filterState = { segment: "", vehicleClass: "", fuel: "" };
let slots = Array.from({length:SLOT_COUNT}, () => null); // stores group.key

/** ============================
 *  UTILS
 *  ============================ */
function normKey(s){
  return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"");
}
function resolveColumn(headerList, candidates){
  const map = new Map(headerList.map(h => [normKey(h), h]));
  for(const c of candidates){
    const k = normKey(c);
    if(map.has(k)) return map.get(k);
  }
  for(const c of candidates){
    const ck = normKey(c);
    for(const h of headerList){
      if(normKey(h).includes(ck)) return h;
    }
  }
  return null;
}
function detectColumns(headerList){
  return {
    brand: resolveColumn(headerList, ["brand","make","manufacturer","oem","marque","märke"]),
    model: resolveColumn(headerList, ["model","carline","vehicle","name","modelname"]),
    variant: resolveColumn(headerList, ["variant","trim","version","derivative","grade"]),
    year: resolveColumn(headerList, ["year","modelyear","my"]),
    segment: resolveColumn(headerList, ["segment","bodysegment","segmentgroup","bodystyle","body"]),
    vehicleClass: resolveColumn(headerList, ["vehicleclass","pcv_lcv","pcv/lcv","class","vehicletype"]),
    fuel: resolveColumn(headerList, ["fuel","fueltype","powertrain","energy","drivetrain"])
  };
}
function normBrand(s){
  return String(s||"").trim().toUpperCase()
    .replace(/&/g,"AND")
    .replace(/\s+/g,"-")
    .replace(/[^A-Z0-9-]/g,"");
}
function normModel(s){
  return String(s||"").trim().toUpperCase()
    .replace(/&/g,"AND")
    .replace(/[\/\\]+/g,"_")
    .replace(/\s+/g,"_")
    .replace(/[^A-Z0-9_-]/g,"");
}
function groupTitle(g){
  return `${g.brand||""} ${g.model||""}`.trim() || g.key;
}
function rowSubline(r){
  const seg = cols.segment ? r[cols.segment] : "";
  const vc  = cols.vehicleClass ? r[cols.vehicleClass] : "";
  const fuel= cols.fuel ? r[cols.fuel] : "";
  return [seg,vc,fuel].filter(Boolean).join(" • ");
}
function imageUrlForGroup(g){
  if(missingImage.has(g.key)) return FALLBACK_ICON;
  const brand = normBrand(g.brand);
  const model = normModel(g.model);
  if(!brand || !model) return FALLBACK_ICON;
  return `./images/${brand}_${model}.png`;
}

function selectedKeys(){ return slots.filter(Boolean); }
function isSelected(key){ return slots.includes(key); }
function firstEmptySlot(){ return slots.findIndex(x => !x); }
function removeKey(key){
  const idx = slots.findIndex(x => x === key);
  if(idx >= 0){
    slots[idx] = null;
    persistSelection();
    renderAll();
  }
}
function placeInSlot(slotIndex, key){
  if(!key) return;
  const from = slots.findIndex(x => x === key);
  if(from >= 0) slots[from] = null;
  slots[slotIndex] = key;
  persistSelection();
  renderAll();
}
function addToFirstEmpty(key){
  const i = firstEmptySlot();
  if(i < 0){
    alert(`Ring is full (${SLOT_COUNT}). Remove one first.`);
    return;
  }
  placeInSlot(i, key);
}
function toggleSelect(key){
  if(isSelected(key)) removeKey(key);
  else addToFirstEmpty(key);
}

/** ============================
 *  CSV LOADER
 *  ============================ */
async function loadCSV(){
  const res = await fetch(CSV_PATH, { cache:"no-store" });
  if(!res.ok) throw new Error(`Failed to load ${CSV_PATH} (${res.status})`);
  const text = await res.text();
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  headers = parsed.meta?.fields || Object.keys(parsed.data?.[0] || {});
  rawRows = parsed.data || [];
  cols = detectColumns(headers);

  // enrich rows with stable __id per csv-row
  const idCol = resolveColumn(headers, ["id","vehicle_id","product_id","uuid","key"]);
  rows = rawRows.map((r, idx) => {
    const b = cols.brand ? r[cols.brand] : "";
    const m = cols.model ? r[cols.model] : "";
    const stable = (idCol && r[idCol]) ? String(r[idCol]) : `${normBrand(b)}_${normModel(m)}_${idx}`;
    return { ...r, __id: stable, __idx: idx };
  });

  // build unique brand/model groups
  groupMap = new Map();
  const brandCol = cols.brand;
  const modelCol = cols.model;

  for(const r of rows){
    const brand = brandCol ? (r[brandCol] || "") : "";
    const model = modelCol ? (r[modelCol] || "") : "";
    const key = `${normBrand(brand)}_${normModel(model)}`.trim();
    if(!key || key === "_") continue;

    if(!groupMap.has(key)){
      groupMap.set(key, { key, brand, model, sampleRow: r, rows: [] });
    }
    groupMap.get(key).rows.push(r);
  }
  groups = Array.from(groupMap.values()).sort((a,b)=>groupTitle(a).localeCompare(groupTitle(b)));

  document.getElementById("dataBadge").textContent = CSV_PATH;
}

/** ============================
 *  FILTERS
 *  ============================ */
function applyFiltersGroups(list){
  const segCol = cols.segment;
  const vcCol = cols.vehicleClass;
  const fuelCol = cols.fuel;

  return list.filter(g => {
    const r = g.sampleRow;

    if(filterState.segment && segCol){
      if(String(r[segCol]||"") !== filterState.segment) return false;
    }
    if(filterState.vehicleClass && vcCol){
      if(String(r[vcCol]||"").toUpperCase() !== filterState.vehicleClass) return false;
    }
    if(filterState.fuel && fuelCol){
      if(String(r[fuelCol]||"") !== filterState.fuel) return false;
    }
    return true;
  });
}
function uniqueValuesFromGroups(col){
  const s = new Set();
  for(const g of groups){
    const r = g.sampleRow;
    const v = (r[col] ?? "").toString().trim();
    if(v) s.add(v);
  }
  return Array.from(s).sort((a,b)=>a.localeCompare(b));
}

function buildSegmentList(){
  const el = document.getElementById("segmentList");
  el.innerHTML = "";

  const segCol = cols.segment;

  const allBtn = document.createElement("div");
  allBtn.className = "segitem" + (filterState.segment==="" ? " active" : "");
  allBtn.innerHTML = `<span>All segments</span><small>${groups.length} models</small>`;
  allBtn.onclick = () => { filterState.segment=""; renderAll(); };
  el.appendChild(allBtn);

  if(!segCol){
    const info = document.createElement("div");
    info.style.color = "var(--muted)";
    info.style.fontWeight = "750";
    info.style.marginTop = "8px";
    info.textContent = "No Segment column detected in CSV.";
    el.appendChild(info);
    return;
  }

  const counts = new Map();
  for(const g of groups){
    const v = String(g.sampleRow[segCol]||"").trim();
    if(!v) continue;
    counts.set(v, (counts.get(v)||0)+1);
  }

  const segs = Array.from(counts.keys()).sort((a,b)=>a.localeCompare(b));
  for(const s of segs){
    const item = document.createElement("div");
    item.className = "segitem" + (filterState.segment===s ? " active" : "");
    item.innerHTML = `<span>${s}</span><small>${counts.get(s)} models</small>`;
    item.onclick = () => { filterState.segment = s; renderAll(); };
    el.appendChild(item);
  }
}

function buildFuelSelect(){
  const fuelCol = cols.fuel;
  const sel = document.getElementById("fuelSelect");
  sel.innerHTML = `<option value="">All fuels</option>`;

  if(!fuelCol){
    sel.disabled = true;
    return;
  }
  sel.disabled = false;

  const vals = uniqueValuesFromGroups(fuelCol);
  for(const v of vals){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    if(v === filterState.fuel) opt.selected = true;
    sel.appendChild(opt);
  }
}

/** ============================
 *  RING UI
 *  ============================ */
function initRingSlots(){
  const ring = document.getElementById("ring");
  ring.innerHTML = "";

  for(let i=0;i<SLOT_COUNT;i++){
    const slot = document.createElement("div");
    slot.className = "slot empty";
    slot.dataset.slot = String(i);
    slot.textContent = "Empty";

    const angle = (-90 + (360 / SLOT_COUNT) * i) * Math.PI/180;
    const radius = 42;
    const cx = 50 + radius * Math.cos(angle);
    const cy = 50 + radius * Math.sin(angle);
    slot.style.left = cx + "%";
    slot.style.top  = cy + "%";

    slot.addEventListener("dragover", e => {
      e.preventDefault();
      slot.classList.add("over");
    });
    slot.addEventListener("dragleave", () => slot.classList.remove("over"));
    slot.addEventListener("drop", e => {
      e.preventDefault();
      slot.classList.remove("over");
      const key = e.dataTransfer.getData("text/plain");
      const idx = Number(slot.dataset.slot);
      if(key) placeInSlot(idx, key);
    });

    ring.appendChild(slot);
  }
}

function renderRing(){
  const picked = selectedKeys().length;
  document.getElementById("pickedBadge").textContent = `${picked}/${SLOT_COUNT} picked`;

  const ring = document.getElementById("ring");
  const slotEls = ring.querySelectorAll(".slot");

  slotEls.forEach(el => {
    const idx = Number(el.dataset.slot);
    const key = slots[idx];

    el.innerHTML = "";
    el.className = "slot" + (key ? "" : " empty");

    if(!key){
      el.textContent = "Empty";
      return;
    }

    const g = groupMap.get(key);
    const name = g ? groupTitle(g) : key;

    const thumb = document.createElement("div");
    thumb.className = "thumb";
    const img = document.createElement("img");
    img.alt = name;
    img.loading = "lazy";
    img.src = g ? imageUrlForGroup(g) : FALLBACK_ICON;
    img.onerror = () => {
      missingImage.add(key);
      img.src = FALLBACK_ICON;
    };
    thumb.appendChild(img);

    const title = document.createElement("div");
    title.className = "name";
    title.textContent = name;

    const x = document.createElement("div");
    x.className = "x";
    x.textContent = "×";
    x.title = "Remove";
    x.onclick = (ev) => {
      ev.stopPropagation();
      removeKey(key);
    };

    el.appendChild(thumb);
    el.appendChild(title);
    el.appendChild(x);
  });
}

/** ============================
 *  MODELS GRID (GROUPED)
 *  ============================ */
function renderGrid(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const filtered = applyFiltersGroups(groups);
  document.getElementById("shownBadge").textContent = `${filtered.length} shown`;

  for(const g of filtered){
    const key = g.key;

    const card = document.createElement("div");
    card.className = "card" + (isSelected(key) ? " selected" : "");
    card.draggable = true;

    card.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", key);
      e.dataTransfer.effectAllowed = "move";
    });

    card.onclick = () => toggleSelect(key);

    const t = document.createElement("div");
    t.className = "thumb";
    const img = document.createElement("img");
    img.alt = groupTitle(g);
    img.loading = "lazy";
    img.src = imageUrlForGroup(g);
    img.onerror = () => {
      missingImage.add(key);
      img.src = FALLBACK_ICON;
    };
    t.appendChild(img);

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = groupTitle(g);

    const sub = document.createElement("div");
    sub.className = "sub";
    sub.textContent = rowSubline(g.sampleRow) || "—";

    const tags = document.createElement("div");
    tags.className = "tags";

    const segCol = cols.segment, vcCol = cols.vehicleClass, fuelCol = cols.fuel;
    const tagVals = [
      segCol ? g.sampleRow[segCol] : null,
      vcCol ? String(g.sampleRow[vcCol]||"").toUpperCase() : null,
      fuelCol ? g.sampleRow[fuelCol] : null
    ].filter(Boolean).slice(0,3);

    for(const tv of tagVals){
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = String(tv);
      tags.appendChild(tag);
    }
    const trimTag = document.createElement("span");
    trimTag.className = "tag";
    trimTag.textContent = `${g.rows.length} trims`;
    tags.appendChild(trimTag);

    meta.appendChild(name);
    meta.appendChild(sub);
    meta.appendChild(tags);

    card.appendChild(t);
    card.appendChild(meta);
    grid.appendChild(card);
  }
}

/** ============================
 *  PERSISTENCE + NAV
 *  ============================ */
const SELECTION_KEY = "egaux_selected_groupkeys_v1";
const META_KEY = "egaux_selection_meta_v1";

function persistSelection(){
  localStorage.setItem(SELECTION_KEY, JSON.stringify(selectedKeys()));
  localStorage.setItem(META_KEY, JSON.stringify({
    reportStyle: document.getElementById("reportStyle").value,
    notes: document.getElementById("notes").value,
    ts: Date.now()
  }));
}
function loadPersistedSelection(){
  try{
    const raw = localStorage.getItem(SELECTION_KEY);
    if(!raw) return;
    const keys = JSON.parse(raw);
    if(Array.isArray(keys) && keys.length){
      slots = Array.from({length:SLOT_COUNT}, () => null);
      for(let i=0;i<Math.min(keys.length,SLOT_COUNT);i++){
        slots[i] = keys[i];
      }
    }
  }catch{}
  try{
    const meta = JSON.parse(localStorage.getItem(META_KEY) || "{}");
    if(meta.reportStyle) document.getElementById("reportStyle").value = meta.reportStyle;
    if(meta.notes) document.getElementById("notes").value = meta.notes;
  }catch{}
}
function openCompare(){
  const keys = selectedKeys();
  if(!keys.length){
    alert("Pick at least one model for comparison.");
    return;
  }
  persistSelection();
  window.location.href = COMPARE_PAGE;
}

/** ============================
 *  RENDER ALL
 *  ============================ */
function renderAll(){
  buildSegmentList();
  buildFuelSelect();
  renderRing();
  renderGrid();
}

/** ============================
 *  INIT
 *  ============================ */ 
(async function init(){
  initRingSlots();

  document.getElementById("vehicleClassSelect").addEventListener("change", (e)=>{
    filterState.vehicleClass = e.target.value;
    renderAll();
  });
  document.getElementById("fuelSelect").addEventListener("change", (e)=>{
    filterState.fuel = e.target.value;
    renderAll();
  });
  document.getElementById("clearFiltersBtn").onclick = ()=>{
    filterState = { segment:"", vehicleClass:"", fuel:"" };
    document.getElementById("vehicleClassSelect").value = "";
    document.getElementById("fuelSelect").value = "";
    renderAll();
  };

  document.getElementById("openCompareBtn").onclick = openCompare;

  try{
    await loadCSV();
    loadPersistedSelection();
    renderAll();
  }catch(err){
    console.error(err);
    document.getElementById("dataBadge").textContent = "CSV missing";
    alert("Could not load Product_data_filled_updated.csv. Ensure it is deployed next to index.html.");
  }
})();
</script>
</body>
</html>
